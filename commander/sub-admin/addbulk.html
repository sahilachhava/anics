<!DOCTYPE html>
<html>
<head>
	<title>Anics - Dashboard</title>
        <link rel="shortcut icon" href="../assets/login/images/default.png">
        <link rel="icon" type="image/png" href="assets/login/images/default.png"/>
        <link rel="stylesheet" type="text/css" href="assets/login/vendor/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="assets/login/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="assets/login/vendor/animate/animate.css">
        <link rel="stylesheet" type="text/css" href="assets/login/vendor/css-hamburgers/hamburgers.min.css">
        <link rel="stylesheet" type="text/css" href="assets/login/vendor/select2/select2.min.css">
        <link rel="stylesheet" type="text/css" href="assets/login/css/util.css">
        <link rel="stylesheet" type="text/css" href="assets/login/css/main.css">
        <link href="../assets/plugins/morris/morris.css" rel="stylesheet">
        <link href="../assets/plugins/alertify/css/alertify.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/icons.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/style.css" rel="stylesheet" type="text/css">
        <link href="../assets/plugins/prism/prism.css" rel="stylesheet" type="text/css">
        <link href="../assets/plugins/ion-rangeslider/ion.rangeSlider.css" rel="stylesheet" type="text/css"/>
        <link href="../assets/plugins/ion-rangeslider/ion.rangeSlider.skinModern.css" rel="stylesheet" type="text/css"/>
        <link href="../assets/plugins/bootstrap-rating/bootstrap-rating.css" rel="stylesheet" type="text/css">
        <link href="../assets/plugins/fullcalendar/css/fullcalendar.min.css" rel="stylesheet" />
        <link href="../assets/plugins/c3/c3.min.css" rel="stylesheet" type="text/css"  />
        <link rel="stylesheet" href="../assets/plugins/chartist/css/chartist.min.css">
        <link href="../assets/plugins/timepicker/tempusdominus-bootstrap-4.css" rel="stylesheet" />
        <link href="../assets/plugins/timepicker/bootstrap-material-datetimepicker.css" rel="stylesheet">
        <link href="../assets/plugins/clockpicker/jquery-clockpicker.min.css" rel="stylesheet" />
        <link href="../assets/plugins/colorpicker/asColorPicker.min.css" rel="stylesheet" type="text/css" />
        <link href="../assets/plugins/select2/select2.min.css" rel="stylesheet" type="text/css" />
        <link href="../assets/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css" rel="stylesheet">
        <link href="../assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
        <link href="../assets/plugins/bootstrap-touchspin/css/jquery.bootstrap-touchspin.min.css" rel="stylesheet" />
        <link href="../assets/plugins/summernote/summernote-bs4.css" rel="stylesheet" />
        <link href="../assets/plugins/dropzone/dist/dropzone.css" rel="stylesheet" type="text/css">
        <link href="../assets/plugins/dropify/css/dropify.min.css" rel="stylesheet">
        <link type="text/css" href="../assets/plugins/x-editable/css/bootstrap-editable.css" rel="stylesheet">
        <link href="../assets/plugins/jvectormap/jquery-jvectormap-2.0.2.css" rel="stylesheet">
        <link href="../assets/plugins/sweet-alert2/sweetalert2.min.css" rel="stylesheet" type="text/css">
        <link href="../assets/plugins/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
        <link href="../assets/plugins/datatables/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
        <link href="../assets/plugins/datatables/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" />
        <link href="../assets/plugins/RWD-Table-Patterns/dist/css/rwd-table.min.css" rel="stylesheet" type="text/css" media="screen">
</head>

<body class="fixed-left">
<!-- Loader -->
<div id="preloader"><div id="status"><div class="spinner"></div></div></div>

<!-- Begin page -->
<div id="wrapper">
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
<button type="button" class="button-menu-mobile button-menu-mobile-topbar open-left waves-effect">
<i class="ion-close"></i>
</button>

<!-- LOGO -->
<div class="topbar-left">
<div class="text-center">
<a href="index.html" class="logo"><i class="mdi mdi-assistant"></i> Anics</a>
</div>
</div>

<div class="sidebar-inner slimscrollleft">

<div id="sidebar-menu">
<ul>
<li class="menu-title">Main</li>

<li>
<a href="index.html" class="waves-effect">
<i class="mdi mdi-airplay"></i>
<span> Dashboard </span>
</a>
</li>



<li>
<a href="addepisode.html" class="waves-effect">
    <i class="mdi mdi-new-box"></i>
    <span> Add New Episode </span>
</a>
</li>

<li>
<a href="addbulk.html" class="waves-effect">
    <i class="mdi mdi-cloud-upload"></i>
    <span> Add Bulk Episodes </span>
</a>
</li>

<li class="has_sub">
<a href="javascript:void(0);" class="waves-effect"><i class="mdi mdi-panda"></i> <span> Anime </span> <span class="float-right"><i class="mdi mdi-chevron-right"></i></span></a>
<ul class="list-unstyled">
<li><a href="addanime.html">Add Anime</a></li>
<li><a href="anime.html">Manage Anime</a></li>
</ul>
</li>

<li class="has_sub">
<a href="javascript:void(0);" class="waves-effect"><i class="mdi mdi-movie"></i> <span> Movies </span> <span class="float-right"><i class="mdi mdi-chevron-right"></i></span></a>
<ul class="list-unstyled">
<li><a href="addmovie.html">Add Movie</a></li>
<li><a href="movies.html">Manage Movies</a></li>
</ul>
</li>



<li>
<a href="suggestions.html" class="waves-effect">
<i class="mdi mdi-checkbox-multiple-marked-circle-outline"></i>
<span> Suggestions </span>
</a>
</li>



<li>
<a href="reports.html" class="waves-effect">
<i class="mdi mdi mdi-bug"></i>
<span> Reports </span>
</a>
</li>

</ul>
</div>
<div class="clearfix"></div>
</div> <!-- end sidebarinner -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
<div class="content">
<!-- Top Bar Start -->
<div class="topbar" id="topMenu">

</div>
<!-- Top Bar End -->
<div class="page-content-wrapper ">
<div class="container-fluid">
<!-- page title start -->
<div class="row">
<div class="col-sm-12">
<div class="page-title-box">
<h4 class="page-title">Add Bulk Episodes</h4>
</div>
</div>
</div>
<!-- end page title -->
<!-- dashboard content -->
<div class="row">
<div class="col-12">
<div class="card m-b-30">
<div class="card-body">
<h4 class="mt-0 header-title">Fill out the form</h4><br>			
<form onsubmit="addBulk();return false;">

<div class="form-group row">
<label for="example-text-input" class="col-sm-2 col-form-label">Anime</label>
<div class="col-sm-6">
<select class="form-control" id="animeList" onchange="updateSeasons(this);">
    <option value="">Select Anime</option>
</select>
</div>
</div>

<div class="form-group row" id="seasonRow">
<label for="example-text-input" class="col-sm-2 col-form-label">Season</label>
<div class="col-sm-6">
<select class="form-control" id="seasonList">
    <option value="">Select Season</option>
</select>
</div>
</div>

<div class="form-group row">
<label for="example-text-input" class="col-sm-2 col-form-label">Name CSV</label>
<div class="col-sm-6">
<input id="nameCSV" type="file" accept=".csv" required>
</div>
</div>


<div class="form-group row">
<label for="example-text-input" class="col-sm-2 col-form-label">Sub CSV</label>
<div class="col-sm-6">
<input id="subCSV" type="file" accept=".csv" required>
</div>
</div>


<div class="form-group row">
<label for="example-text-input" class="col-sm-2 col-form-label">Dub CSV</label>
<div class="col-sm-6">
<input id="dubCSV" type="file" accept=".csv" required>
</div>
</div>

<div class="form-group">
<label for="example-time-input" class="col-sm-2 col-form-label" ></label>
<div class="col-sm-10">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<button type="submit" id="submitBtn" class="btn btn-primary waves-effect waves-light">Add Bulk</button>
<button type="reset" class="btn btn-secondary waves-effect m-l-5">Reset Form</button>
</div>
</div>
</form>
</div>
</div>
</div> <!-- end col -->
</div> <!-- end row -->

<!-- dashboard content end-->
<footer class="footer" id="footer">
Â© 2021 Anics All Right Reserved.
</footer>
</div>
<!-- End main content here -->
</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/popper.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/modernizr.min.js"></script>
<script src="../assets/js/detect.js"></script>
<script src="../assets/js/fastclick.js"></script>
<script src="../assets/js/jquery.slimscroll.js"></script>
<script src="../assets/js/jquery.blockUI.js"></script>
<script src="../assets/js/waves.js"></script>
<script src="../assets/js/jquery.nicescroll.js"></script>
<script src="../assets/js/jquery.scrollTo.min.js"></script>
<script src="../assets/plugins/alertify/js/alertify.js"></script>
<script src="../assets/pages/alertify-init.js"></script>
<!-- Required datatable js -->
<script src="../assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../assets/plugins/datatables/dataTables.bootstrap4.min.js"></script>
<!-- Buttons examples -->
<script src="../assets/plugins/datatables/dataTables.buttons.min.js"></script>
<script src="../assets/plugins/datatables/buttons.bootstrap4.min.js"></script>
<script src="../assets/plugins/datatables/jszip.min.js"></script>
<script src="../assets/plugins/datatables/pdfmake.min.js"></script>
<script src="../assets/plugins/datatables/vfs_fonts.js"></script>
<script src="../assets/plugins/datatables/buttons.html5.min.js"></script>
<script src="../assets/plugins/datatables/buttons.print.min.js"></script>
<script src="../assets/plugins/datatables/buttons.colVis.min.js"></script>
<!-- Datatable init js -->
<script src="../assets/pages/datatables.init.js"></script>
<!-- Sweet-Alert  -->
<script src="../assets/plugins/sweet-alert2/sweetalert2.min.js"></script>
<script src="../assets/pages/sweet-alert.init.js"></script> 
<!-- Bootstrap inputmask js -->
<script src="../assets/plugins/bootstrap-inputmask/bootstrap-inputmask.min.js" type="text/javascript"></script>
<script src="../assets/plugins/skycons/skycons.min.js"></script>
<script src="../assets/plugins/raphael/raphael-min.js"></script>
<script src="../assets/plugins/morris/morris.min.js"></script>
<script src="../assets/pages/dashborad.js"></script>
<!-- App js -->
<script src="../assets/js/app.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>

<script src="../assets/login/js/main.js"></script>
<script >
    $('.js-tilt').tilt({
            scale: 1.1
    })
</script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-23581568-13');
</script>
<script>
 /* BEGIN SVG WEATHER ICON */
 if (typeof Skycons !== 'undefined'){
var icons = new Skycons(
    {"color": "#fff"},
    {"resizeClear": true}
    ),
        list  = [
            "clear-day", "clear-night", "partly-cloudy-day",
            "partly-cloudy-night", "cloudy", "rain", "sleet", "snow", "wind",
            "fog"
        ],
        i;

    for(i = list.length; i--; )
    icons.set(list[i], list[i]);
    icons.play();
};

// scroll

$(document).ready(function() {
$("#boxscroll").niceScroll({cursorborder:"",cursorcolor:"#cecece",boxzoom:true});
$("#boxscroll2").niceScroll({cursorborder:"",cursorcolor:"#cecece",boxzoom:true}); 
});
</script>
<!-- end login scripts -->
</body>
<script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-storage.js"></script>
<script type="text/javascript" src="../assets/firebase.js"></script>
<script type="text/javascript" src="../assets/papaparse.min.js"></script>
<script type="text/javascript" src="../assets/externalHTML.js"></script>
<script type="text/javascript">
	//loadHeader();
	//loadSideMenu();
	loadTopMenu();
	//loadFooter();

    var uid = sessionStorage.getItem("adminUID");
    if(uid==null){
        window.location.href="../index.html";
    }else{
        db.collection("medias").where("mediaType", "==", "anime").where("status", "==", "Ongoing").get().then((docs)=>{
            docs.forEach((doc)=>{
                var data = doc.data();
                $("#animeList").append('<option value="'+doc.id+'">'+data.name+'</option>');
            })
        });
    }

    function updateSeasons(mediaID){
        db.collection("medias").doc(mediaID.value).get().then((doc)=>{
            var seasons = doc.data().seasons;
            for(var i = 1; i <= seasons; i++){
                $("#seasonList").append('<option value="season'+i+'">Season '+i+'</option>');
            }
        }).then(()=>{
            $("#seasonRow").removeAttr("hidden");
        })
    }

    var episodeDetails = [];
    var subLinks = [];
    var dubLinks = [];
    var allEpisodes = [];

    function addBulk(){
        $('#submitBtn').html('Uploading Bulk...').addClass('disabled');

        $('#nameCSV').parse({
			config: {
				delimiter: "auto",
				complete: parseNameData,
			},
			complete: function()
			{
				$("#subCSV").parse({
                    config: {
                        delimiter: "auto",
                        complete: parseSubData,
                    },
                    complete: function()
                    {
                        $("#dubCSV").parse({
                            config: {
                                delimiter: "auto",
                                complete: parseDubData,
                            },
                            complete: function()
                            {
                                for(var epCntr = 0; epCntr < episodeDetails.length; epCntr++){
                                    var episode = [episodeDetails[epCntr].no, episodeDetails[epCntr].name, "", ""];
                                    for(var sCntr = 0; sCntr < subLinks.length; sCntr++){
                                        if(subLinks[sCntr].no == episodeDetails[epCntr].no){
                                            episode[2] = subLinks[sCntr].sub;
                                            break;
                                        }
                                    }
                                    for(var dCntr = 0; dCntr < dubLinks.length; dCntr++){
                                        if(dubLinks[dCntr].no == episodeDetails[epCntr].no){
                                            episode[3] = dubLinks[dCntr].dub;
                                            break;
                                        }
                                    }
                                    allEpisodes.push(episode);
                                }
                                uploadEpisodes();
                            }
                        });
                    }
                });
			}
		});
    }

    function parseNameData(results){
		var data = results.data;
		for(var i = 1; i < data.length - 1; i++){
			var row = data[i];
			var cells = row.join(",").split(","); 
            
            var no = cells[2];
            var name = cells[3];
            no = no.replaceAll("\"", "");
            name = name.replaceAll("\"", "");

            episodeDetails.push({
                "no": no,
                "name": name
            });
		}
	}

    function parseSubData(results){
		var data = results.data;
		for(var i = 1; i < data.length - 1; i++){
			var row = data[i];
			var cells = row.join(",").split(","); 

            var no = cells[2];
            no = no.replaceAll(" ", "");
            no = no.replaceAll("EP", "");
            no = no.replaceAll("SUB", "");
            no = no.replaceAll(/(?:\r\n|\r|\n)/g, '');
            no = no.replaceAll("\"", "");

            var link = cells[6];
            link = link.replaceAll("\"", "");
            
            subLinks.push({
                "no": no,
                "sub": link
            });
        }
	}

    function parseDubData(results){
		var data = results.data;
		for(var i = 1; i < data.length - 1; i++){
			var row = data[i];
			var cells = row.join(",").split(","); 

            var no = cells[2];
            no = no.replaceAll(" ", "");
            no = no.replaceAll("EP", "");
            no = no.replaceAll("DUB", "");
            no = no.replaceAll(/(?:\r\n|\r|\n)/g, '');
            no = no.replaceAll("\"", "");

            var link = cells[6];
            link = link.replaceAll("\"", "");
            
            dubLinks.push({
                "no": no,
                "dub": link
            });
        }
	}

    function uploadEpisodes(){
        var animeID = $('#animeList').val();
        var season = $('#seasonList').val();
        var timeStamp = firebase.firestore.Timestamp.now().toDate();

        for(var i = 0; i < allEpisodes.length; i++){
            var episode = allEpisodes[i];
            var epName = "S" + season.substr(6, 10).padStart('2', '0') + ":E" + episode[0].padStart('2', '0') + " " + episode[1];

            db.collection("medias").doc(animeID).collection(season).doc(epName).set({
                'name': epName,
                'subbedURL': episode[2],
                'dubbedURL': episode[3],
                'timeStamp': timeStamp
            }).then((doc)=>{
                console.log(epName + " Added Succesfully");
            });
        }
    }
</script>
</html>
